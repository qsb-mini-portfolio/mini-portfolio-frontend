<div class="page">
  <div class="content">
    <div class="container">
      <div class="header">
        <div>
          <h1 class="title">Portfolio Overview</h1>
          <p class="muted">View your current positions and recent transactions.</p>
        </div>
        <button pButton class="btn-warning" (click)="openImport()">
          <i class="pi pi-table"></i>
          <span class="ml-2">Import CSV</span>
        </button>
        <button pButton class="btn-primary" (click)="openAddTransaction()">
          <i class="pi pi-plus"></i>
          <span class="ml-2">Add transaction</span>
        </button>
      </div>



      <!-- Positions -->
      <p-card class="card">
        <ng-template pTemplate="header"><h2>Positions</h2></ng-template>

        <p-table
          #dt
          [value]="filteredStocks"
          [tableStyle]="{'min-width':'800px'}"
          [paginator]="true"
          [rows]="10"
          [sortMode]="'multiple'"
          [globalFilterFields]="['symbol','name','volume','boughtPrice','currentPrice','yieldPct','weightPct']"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="symbol">
                Symbol
              <p-sortIcon field="symbol"></p-sortIcon>

              </th>
              <th pSortableColumn="name">
                Name
              <p-sortIcon field="name"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="volume">
                Quantity
                <p-sortIcon field="volume"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="boughtPrice">
                Bought Price
                <p-sortIcon field="boughtPrice"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="currentPrice">
                Market Value
                <p-sortIcon field="currentPrice"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="yieldPct">
                Performance
              <p-sortIcon field="yieldPct"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="weightPct">
                % of Portfolio
                <p-sortIcon field="weightPct"></p-sortIcon>
              </th>
              <th class="text-right" pSortableColumn="favorite" (click)="toggleFavoriteFilter()">
                Favorite
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-position>
            <tr>
              <td><span class="instrument-symbol">{{ position.symbol }}</span></td>
              <td><span class="instrument-name">{{ position.name }}</span></td>
              <td class="text-right"><span class="tab-number">{{ position.volume }}</span></td>
              <td class="text-right"><span class="tab-number">{{ position.boughtPrice | currencyOrNone }}</span></td>
              <td class="text-right">
                <span class="tab-number">{{ position.currentPrice | currencyOrNone  }}</span>
              </td>
              <td class="text-right">
                <span class="tab-number"><p-tag [severity]="position.yield | transactionSeverity" [value]="position.yield | percentageOrNone"></p-tag></span>
              </td>
              <td class="text-right">
                <span class="tab-number">{{ position.part | percentageOrNone }}</span>
              </td>
             <td>
            <button 
              class="heart-btn" 
              [class.active]="likedSymbols.has(position.symbol)" 
              (click)="toggleLike(position)">
              ‚ù§
            </button>
            </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <!-- Transactions -->
      <p-card class="card">
        <ng-template pTemplate="header"><h2>Transactions</h2></ng-template>
        <p-table
          class="transactions-table"
          [value]="transactions().items"
          [totalRecords]="transactions().totalElements"
          [tableStyle]="{'min-width':'800px'}"
          [paginator]="true"
          [rows]="10"
          [lazy]="true"
          (onLazyLoad)="onPageChange($event)">
          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>Instrument</th>
              <th>BUY/SELL</th>
              <th class="text-right">Quantity</th>
              <th class="text-right">Price</th>
              <th class="text-right">Amount</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-transaction>
            <tr (click)="openTransaction(transaction)" class="transactionRow">
              <td><span class="tab-number">{{ transaction.date | dateOrNone }}</span></td>
              <td><span class="instrument-symbol">{{ transaction.stock.symbol }}</span></td>
              <td>
                <p-tag [severity]="transaction.volume | transactionSeverity" [value]="transaction.volume > 0 ? 'BUY' : 'SELL'"></p-tag>
              </td>
              <td class="text-right"><span class="tab-number">{{ transaction.volume| abs }}</span></td>
              <td class="text-right"><span class="tab-number">{{ transaction.price | currencyOrNone }}</span></td>
              <td class="text-right"><span class="tab-number">{{ ((transaction.volume | abs) * transaction.price) | currencyOrNone }}</span></td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <app-transaction-dialog #transactionDialog (deleteComplete)="onDeleteTransaction()" (updateComplete)="onUpdateTransaction()"></app-transaction-dialog>
      <add-transaction-dialog #addTransactionDialog (completed)="onTransactionCreated()"></add-transaction-dialog>
      <app-import-csv-dialog #importCsvDialog (completed)="onCSVImported()"></app-import-csv-dialog>
    </div>
  </div>
</div>
